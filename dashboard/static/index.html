<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>USDJPY FastPass Dashboard</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@500;700&family=Space+Grotesk:wght@400;600;700&display=swap');
    :root {
      --bg: #0a0f1c;
      --panel: #0f172a;
      --panel-2: #111c33;
      --ink: #e7eefc;
      --muted: #9aa8c7;
      --accent: #27d07d;
      --warn: #f2c94c;
      --error: #ff5c5c;
      --line: #1e2a44;
      --glow: #2b6cb0;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Space Grotesk", system-ui, sans-serif;
      background: radial-gradient(1200px 600px at 70% -10%, #152750 0%, #0a0f1c 50%, #090d19 100%);
      color: var(--ink);
    }
    .wrap { padding: 18px 22px 30px; }
    .topbar {
      display: grid;
      grid-template-columns: 1fr auto auto;
      align-items: center;
      gap: 14px;
      padding: 14px 18px;
      background: linear-gradient(90deg, #0f1b33 0%, #132545 60%, #0f1b33 100%);
      border: 1px solid #1f2b44;
      border-radius: 14px;
      box-shadow: 0 0 24px rgba(22, 74, 138, 0.25);
      margin-bottom: 14px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: "Chakra Petch", sans-serif;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .brand .logo {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      background: conic-gradient(from 180deg, #2ecc71, #2b6cb0, #2ecc71);
      box-shadow: 0 0 18px rgba(39, 208, 125, 0.25);
    }
    .top-metrics {
      display: grid;
      grid-template-columns: repeat(3, minmax(160px, 1fr));
      gap: 12px;
    }
    .metric-card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px 12px;
    }
    .metric-card span {
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    .metric-card strong {
      display: block;
      font-size: 18px;
      font-weight: 700;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #22314f;
      background: #0f1b33;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #888;
      box-shadow: 0 0 8px rgba(255,255,255,0.2);
    }
    .control-bar {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-bottom: 14px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
    }
    select {
      padding: 6px 10px;
      background: #0e162b;
      color: var(--ink);
      border: 1px solid #22314f;
      border-radius: 8px;
    }
    button {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-start { background: var(--accent); color: #04130b; }
    .btn-stop { background: var(--error); color: #fff; }
    .btn-ghost { background: #1b2a44; color: var(--ink); }
    .badges { display: flex; flex-wrap: wrap; gap: 8px; }
    .badge {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #23314f;
      background: #101a2f;
    }
    .badge.ok { color: var(--accent); }
    .badge.warn { color: var(--warn); }
    .badge.err { color: var(--error); }
    .grid {
      display: grid;
      grid-template-columns: 280px minmax(520px, 1fr) 360px;
      gap: 14px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
    }
    .card h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .gauge-wrap { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .gauge {
      position: relative;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: conic-gradient(var(--accent) 0deg, #243352 0deg);
      margin: auto;
    }
    .gauge-inner {
      position: absolute;
      inset: 10px;
      background: #0c1428;
      border-radius: 50%;
      display: grid;
      place-items: center;
      text-align: center;
      font-size: 12px;
      color: var(--muted);
    }
    .gauge-value { font-size: 18px; color: var(--ink); font-weight: 700; }
    .lineup-list { display: grid; gap: 8px; }
    .lineup-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      border: 1px solid #22314f;
      border-radius: 8px;
      background: #0d172c;
      font-size: 12px;
    }
    .lineup-status {
      padding: 3px 8px;
      border-radius: 999px;
      background: #14304f;
      color: var(--accent);
      font-size: 11px;
    }
    .chart {
      height: 320px;
      background: #0b1326;
      border: 1px solid #1a2740;
      border-radius: 10px;
      padding: 8px;
    }
    canvas { width: 100%; height: 100%; }
    .playbyplay {
      max-height: 320px;
      overflow-y: auto;
      font-size: 12px;
      color: var(--muted);
    }
    .latest-trades {
      max-height: 320px;
      overflow-y: auto;
    }
    .play-item { padding: 6px 0; border-bottom: 1px solid #1b2a44; }
    .ai-panel textarea {
      width: 100%;
      background: #0b1326;
      border: 1px solid #1b2a44;
      border-radius: 8px;
      color: var(--ink);
      padding: 8px;
      min-height: 60px;
    }
    .table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .table th, .table td { padding: 6px 8px; border-bottom: 1px solid #1b2a44; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>Omega-FX</div>
      </div>
      <div class="top-metrics">
        <div class="metric-card">
          <span>Account Balance</span>
          <strong id="account-balance">-</strong>
        </div>
        <div class="metric-card">
          <span>Equity</span>
          <strong id="account-equity">-</strong>
        </div>
        <div class="metric-card">
          <span>System Status</span>
          <div class="status-pill">
            <span class="status-dot" id="system-dot"></span>
            <span id="system-status">OFFLINE</span>
          </div>
        </div>
      </div>
      <div class="badges">
        <span id="mode-badge" class="badge warn">Game Mode: ?</span>
        <span id="portfolio-badge" class="badge warn">Lineup: ?</span>
        <span id="runner-badge" class="badge warn">Runner: ?</span>
        <span id="mt5-env-badge" class="badge warn">MT5 env: ?</span>
        <span id="heartbeat" class="badge warn">Heartbeat: ?</span>
      </div>
    </div>

    <div class="control-bar">
      <div class="controls">
        <label>Game Mode:
          <select id="mode-select">
            <option value="shadow">Shadow</option>
            <option value="demo">Demo</option>
            <option value="ftmo">FTMO</option>
          </select>
        </label>
        <label>Lineup Selector:
          <select id="portfolio-select">
            <option value="core">Curry Lineup (Core)</option>
            <option value="v3">Curry Lineup (V3)</option>
            <option value="multi">Splash Brothers Lineup (Multi)</option>
          </select>
        </label>
        <button class="btn-start" onclick="startBot()">Enable Bot</button>
        <button class="btn-stop" onclick="stopBot()">Disable Bot</button>
        <button class="btn-ghost" id="reset-btn">Hard Reset State</button>
        <span id="stop-reason" class="badge warn" style="display:none;"></span>
      </div>
    </div>

    <div class="grid">
      <div>
        <div class="card">
          <h3>Risk Management (Draymond)</h3>
          <div class="gauge-wrap">
            <div>
              <div id="dd-gauge" class="gauge">
                <div class="gauge-inner">
                  <div>Max DD</div>
                  <div class="gauge-value" id="dd-value">-</div>
                </div>
              </div>
            </div>
            <div>
              <div id="pnl-gauge" class="gauge">
                <div class="gauge-inner">
                  <div>PnL Today</div>
                  <div class="gauge-value" id="pnl-value">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Coach Summary</h3>
          <div id="coach-summary">Loading...</div>
        </div>
        <div class="card">
          <h3>Active Lineup</h3>
          <div id="roster">Loading...</div>
        </div>
        <div class="card">
          <h3>Manual Override</h3>
          <button class="btn-stop" onclick="stopBot()">Emergency Stop</button>
        </div>
      </div>

      <div>
        <div class="card">
          <h3>Live Data</h3>
          <div class="chart">
            <canvas id="equity-chart"></canvas>
          </div>
        </div>
        <div class="card">
          <h3>Team Stats</h3>
          <div id="comparison">Loading...</div>
        </div>
      </div>

      <div>
        <div class="card">
          <h3>Play-by-Play</h3>
          <div id="latest-trades-simple">Loading...</div>
        </div>
        <div class="card ai-panel">
          <h3>AI Coach & Co-Pilot Assist</h3>
          <div id="ai-chat-log" style="max-height:220px; overflow-y:auto; font-size:12px; color:var(--muted); border:1px solid #1b2a44; padding:8px; border-radius:8px; margin-bottom:8px;">
            No messages yet.
          </div>
          <textarea id="ai-input" placeholder="Ask the AI Co-Pilot..."></textarea>
          <div style="margin-top:8px;">
            <button class="btn-ghost" onclick="askAi()">Ask AI Co-Pilot</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <details>
        <summary style="cursor:pointer;">Help / Playbook (click to expand)</summary>
        <div style="font-size:13px; color:var(--muted); line-height:1.5; margin-top:8px;">
          Shadow: Mode=Shadow, Portfolio=Core/V3/Multi. OMEGAFX_LIVE_MODE=0, writes shadow log.<br>
          Demo: Mode=Demo, Portfolio=V3 or Multi. Sends demo orders to MT5; writes demo log.<br>
          FTMO sims: Use "Run FTMO" buttons to run pipelines; JSONs in reports/.<br>
          Logs/Reports: Shadow log in logs/shadow_fastpass_usdjpy_core.csv (or selected), demo logs in logs/demo_usdjpy_v3_equity.csv or demo_multi_equity.csv, FTMO JSONs in reports/.
        </div>
      </details>
    </div>

    <div id="advanced-view" class="hidden">
      <div class="card">
        <h3>Latest Trades (Detailed)</h3>
        <div id="latest-trades-adv">Loading...</div>
      </div>
      <div class="card">
        <h3>Player Impact / Trades & PnL</h3>
        <div id="edge-impact">Loading...</div>
      </div>
      <div class="card">
        <h3>Task Flight Deck</h3>
        <div id="flight-deck">Loading...</div>
      </div>
      <div class="card">
        <h3>Recent Outputs</h3>
        <div id="recent-list">Loading...</div>
      </div>
    </div>
  </div>

  <script>
    const simpleBtn = document.getElementById('simple-btn');
    const advancedBtn = document.getElementById('advanced-btn');
    const advView = document.getElementById('advanced-view');
    const viewLabel = document.getElementById('view-mode-label');
    const resetBtn = document.getElementById('reset-btn');
    let lastTrades = [];

    if (simpleBtn && advancedBtn) {
      simpleBtn.onclick = () => {
        advView.classList.add('hidden');
        if (viewLabel) viewLabel.textContent = 'Simple View';
      };
      advancedBtn.onclick = () => {
        advView.classList.remove('hidden');
        if (viewLabel) viewLabel.textContent = 'Advanced View';
      };
    }

    if (resetBtn) {
      resetBtn.onclick = async () => {
        await fetch('/reset_state', {method:'POST'});
      };
    }

    function setBadge(el, text, ok) {
      if (!el) return;
      el.textContent = text;
      el.className = 'badge ' + (ok ? 'ok' : 'warn');
    }

    async function fetchJson(url, opts={}) {
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function startBot() {
      const mode = document.getElementById('mode-select').value;
      const portfolio = document.getElementById('portfolio-select').value;
      await fetchJson('/start', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({mode, portfolio})});
    }

    async function stopBot() {
      await fetchJson('/stop', {method:'POST'});
    }

    function setGauge(id, value, maxAbs) {
      const el = document.getElementById(id);
      if (!el) return;
      const abs = Math.min(Math.abs(value || 0), maxAbs);
      const pct = (abs / maxAbs) * 100;
      el.style.background = `conic-gradient(var(--accent) ${pct}%, #243352 0)`;
    }

    function renderComparison(data) {
      if (!data) return 'No data';
      const rows = [];
      const addRow = (label, obj) => {
        if (!obj) return;
        const pr = obj.pass_rate ?? obj.pipeline_success_rate ?? null;
        const dd = obj.max_dd ?? obj.max_dd_live_worst ?? null;
        const days = obj.median_days_to_payout ?? obj.total_days_to_payout_median ?? null;
        rows.push(`<tr>
          <td>${label}</td>
          <td>${pr != null ? (pr * 100).toFixed(1) + '%' : '-'}</td>
          <td>${obj.avg_return != null ? obj.avg_return.toFixed(2) + '%' : '-'}</td>
          <td>${dd != null ? (dd * 100).toFixed(2) + '%' : '-'}</td>
          <td>${days != null ? days.toFixed(1) : '-'}</td>
          <td>${obj.symbol_pass_counts ? JSON.stringify(obj.symbol_pass_counts) : '-'}</td>
        </tr>`);
      };
      addRow('Curry (V3)', data.v3);
      addRow('GBPJPY Core', data.gbpjpy_core);
      addRow('Multi', data.multi_symbol);
      addRow('EXP_V2 (USDJPY)', data.exp_v2);
      addRow('EXP_V2 Multi', data.exp_v2_multi);
      addRow('EXP_V3 (Dynasty)', data.exp_v3);
      addRow('EXP_V3 Multi', data.exp_v3_multi);
      return `<table class="table">
        <tr><th>Lineup</th><th>Pass Rate</th><th>Avg Return</th><th>Worst DD</th><th>Median Days</th><th>Symbol Pass</th></tr>
        ${rows.join('')}
      </table>`;
    }

    function renderRoster(roster) {
      const rows = Object.entries(roster || {}).map(([name, info]) => {
        return `<div class="lineup-item">
          <div>${name}</div>
          <div class="lineup-status">${info.role || 'Online'}</div>
        </div>`;
      });
      return `<div class="lineup-list">${rows.join('')}</div>`;
    }

    function renderEdgeImpact(impact) {
      if (!impact) return 'No data';
      const rows = Object.entries(impact).map(([edge, stats]) => {
        return `<tr>
          <td>${edge}</td>
          <td>${stats.trades ?? 0}</td>
          <td>${stats.pnl_pct ? stats.pnl_pct.toFixed(4) + '%' : '0%'}</td>
          <td>${stats.avg_win ? stats.avg_win.toFixed(4)+'%' : '-'}</td>
          <td>${stats.avg_loss ? stats.avg_loss.toFixed(4)+'%' : '-'}</td>
        </tr>`;
      });
      return `<table class="table">
        <tr><th>Player</th><th>Trades</th><th>PnL%</th><th>Avg Win%</th><th>Avg Loss%</th></tr>
        ${rows.join('')}
      </table>`;
    }

    function renderLatestTrades(trades) {
      if (!trades || !trades.length) return 'No trades yet.';
      const sorted = [...trades].sort((a,b) => (b.timestamp||'').localeCompare(a.timestamp||''));
      return `<div class="latest-trades">
        ${sorted.map(t => `
          <div class="play-item">
            <strong>${t.timestamp || ''}</strong> | ${t.symbol || ''} | ${t.strategy_name_friendly || t.strategy_id || ''} ${t.side || ''} | ${typeof t.pnl_pct === 'number' ? t.pnl_pct.toFixed(4)+'%' : '0%'}
          </div>`).join('')}
      </div>`;
    }

    function updateChart(trades) {
      const canvas = document.getElementById('equity-chart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const width = canvas.clientWidth;
      const height = canvas.clientHeight;
      canvas.width = width;
      canvas.height = height;
      ctx.clearRect(0,0,width,height);
      const pts = trades.filter(t => typeof t.equity_after_trade === 'number');
      if (!pts.length) {
        ctx.fillStyle = '#5b6b8a';
        ctx.font = '12px Space Grotesk';
        ctx.fillText('No equity data yet', 10, 20);
        return;
      }
      const values = pts.map(p => p.equity_after_trade);
      const min = Math.min(...values);
      const max = Math.max(...values);
      const range = max - min || 1;
      ctx.strokeStyle = '#2ecc71';
      ctx.lineWidth = 2;
      ctx.beginPath();
      values.forEach((v, i) => {
        const x = (i / (values.length - 1)) * (width - 20) + 10;
        const y = height - ((v - min) / range) * (height - 20) - 10;
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    function renderCoachSummary(status, metrics) {
      const hbFresh = metrics && metrics.last_heartbeat_time;
      const hbText = hbFresh ? `Heartbeat OK - last: ${metrics.last_heartbeat_time}` : 'Heartbeat stale or missing';
      const runnerText = status.running ? 'RUNNING' : 'STOPPED';
      const symList = (metrics && metrics.symbols_today && metrics.symbols_today.length) ? metrics.symbols_today.join(', ') : '-';
      const stopReason = status.last_stop_reason ? `Stop reason: ${status.last_stop_reason}` : '';
      const balance = metrics.account_balance != null ? metrics.account_balance.toFixed(2) : '-';
      const equity = metrics.account_equity != null ? metrics.account_equity.toFixed(2) : '-';
      return `
        <div class="tile-wrap">
          <div class="tile"><h4>Mode</h4><div class="metric">${status.mode || '-'}</div></div>
          <div class="tile"><h4>Lineup</h4><div class="metric">${status.portfolio || '-'}</div></div>
          <div class="tile"><h4>Runner</h4><div class="metric">${runnerText}</div><div style="font-size:12px;">${hbText}</div></div>
          <div class="tile"><h4>Trades Today</h4><div class="metric">${metrics.trades_today ?? 0}</div><div style="font-size:12px;">Wins: ${metrics.wins_today ?? 0} | Losses: ${metrics.losses_today ?? 0}</div></div>
          <div class="tile"><h4>PnL Today</h4><div class="metric">${metrics.pnl_today_pct != null ? metrics.pnl_today_pct.toFixed(4)+'%' : '0%'}</div><div style="font-size:12px;">Max DD: ${metrics.max_dd_today_pct != null ? metrics.max_dd_today_pct.toFixed(4)+'%' : '-'}</div></div>
          <div class="tile"><h4>Symbols</h4><div class="metric">${symList}</div><div style="font-size:12px;">Last trade: ${metrics.last_trade_time || '-'}</div></div>
          <div class="tile"><h4>Equity</h4><div class="metric">Balance: ${balance} | Equity: ${equity}</div></div>
        </div>
        <div style="font-size:12px; color:var(--muted); margin-top:6px;">${stopReason}</div>
      `;
    }

    async function refreshAll() {
      let status = {};
      let live = {};
      let recent = [];
      try { status = await fetchJson('/status'); } catch (e) {}
      try { live = await fetchJson('/live_metrics'); } catch (e) {}
      try {
        const rt = await fetchJson('/recent_trades');
        recent = Array.isArray(rt) ? rt : (rt.trades || []);
      } catch (e) {}
      lastTrades = recent;

      // top bar
      const balanceEl = document.getElementById('account-balance');
      const equityEl = document.getElementById('account-equity');
      if (balanceEl) balanceEl.textContent = live.account_balance != null ? live.account_balance.toFixed(2) : '-';
      if (equityEl) equityEl.textContent = live.account_equity != null ? live.account_equity.toFixed(2) : '-';
      const statusEl = document.getElementById('system-status');
      const dot = document.getElementById('system-dot');
      if (statusEl) statusEl.textContent = status.running ? 'ONLINE' : 'OFFLINE';
      if (dot) dot.style.background = status.running ? 'var(--accent)' : '#666';

      setBadge(document.getElementById('mode-badge'), `Game Mode: ${status.mode || '?'}`, !!status.mode);
      setBadge(document.getElementById('portfolio-badge'), `Lineup: ${status.portfolio || '?'}`, !!status.portfolio);
      setBadge(document.getElementById('runner-badge'), `Runner: ${status.running ? 'RUNNING' : 'STOPPED'}`, status.running);
      const mt5Env = status.mt5_env_present || {};
      const mt5Ok = mt5Env.login && mt5Env.password && mt5Env.server;
      setBadge(document.getElementById('mt5-env-badge'), `MT5 env: ${mt5Ok ? 'present' : 'missing'}`, mt5Ok);
      const hb = document.getElementById('heartbeat');
      if (hb) setBadge(hb, live.last_heartbeat_time ? `Heartbeat OK ${live.last_heartbeat_time}` : 'Heartbeat missing', !!live.last_heartbeat_time);
      const stop = document.getElementById('stop-reason');
      if (stop) {
        if (status.last_stop_reason) {
          stop.style.display = 'inline-block';
          stop.textContent = status.last_stop_reason;
        } else stop.style.display = 'none';
      }

      // coach summary
      const coach = document.getElementById('coach-summary');
      if (coach) coach.innerHTML = renderCoachSummary(status, live);

      // gauges
      setGauge('dd-gauge', live.max_dd_today_pct || 0, 10);
      setGauge('pnl-gauge', live.pnl_today_pct || 0, 10);
      const ddVal = document.getElementById('dd-value');
      const pnlVal = document.getElementById('pnl-value');
      if (ddVal) ddVal.textContent = (live.max_dd_today_pct != null ? live.max_dd_today_pct.toFixed(2) : '-') + '%';
      if (pnlVal) pnlVal.textContent = (live.pnl_today_pct != null ? live.pnl_today_pct.toFixed(2) : '-') + '%';

      document.getElementById('latest-trades-simple').innerHTML = renderLatestTrades(recent);
      const adv = document.getElementById('latest-trades-adv');
      if (adv) adv.innerHTML = renderLatestTrades(recent);
      updateChart(recent);

      try {
        const cmp = await fetchJson('/comparison');
        document.getElementById('comparison').innerHTML = renderComparison(cmp);
      } catch (e) { document.getElementById('comparison').textContent = 'Error loading team stats'; }
      try {
        const roster = await fetchJson('/config_snapshot');
        document.getElementById('roster').innerHTML = renderRoster(roster.roster || roster);
      } catch (e) { document.getElementById('roster').textContent = 'Error loading roster'; }
      try {
        const edge = await fetchJson('/edge_impact');
        document.getElementById('edge-impact').innerHTML = renderEdgeImpact(edge);
      } catch (e) { document.getElementById('edge-impact').textContent = 'Error loading edge impact'; }
      try {
        const fd = await fetchJson('/tasks');
        document.getElementById('flight-deck').innerHTML = fd.map(x=>`<div>${x}</div>`).join('');
      } catch (e) { document.getElementById('flight-deck').textContent = 'Error loading tasks'; }
      try {
        const rl = await fetchJson('/recent_reports');
        document.getElementById('recent-list').innerHTML = rl.map(x=>`<div>${x}</div>`).join('');
      } catch (e) { document.getElementById('recent-list').textContent = 'Error loading outputs'; }
    }

    refreshAll();
    setInterval(refreshAll, 7000);
    window.addEventListener('resize', () => updateChart(lastTrades));

    async function askAi() {
      const input = document.getElementById('ai-input');
      const log = document.getElementById('ai-chat-log');
      const question = (input.value || '').trim();
      if (!question) return;
      input.value = '';
      log.innerHTML += `<div><strong>You:</strong> ${question}</div>`;
      try {
        const ctx = await fetchJson('/ai_context');
        const res = await fetchJson('/ai_query', {method:'POST', body: JSON.stringify({user_message: question, ai_context: ctx})});
        log.innerHTML += `<div><strong>AI:</strong> ${res.answer || res.result || 'No response'}</div>`;
      } catch (e) {
        log.innerHTML += `<div style="color:var(--error);"><strong>AI error:</strong> ${e.message}</div>`;
      }
      log.scrollTop = log.scrollHeight;
    }
  </script>
</body>
</html>
